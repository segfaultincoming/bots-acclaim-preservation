# Dora the Explorer

Alright, I lied.

## I explored

But not Ghidra scripts. I had a feeling that something awful would happen. I didn't want to risk it.

### Manual Virtual Address Table disassembly

`15,230` entries, 4 bytes each. `3,807` JMP instructions. Luckily most of them were disassembled, I would say about 70%.

But that didn't stop my exploration. I have taken a look at every, yes **every**, function approximation. To make it simple for you, reader - `3,807` functions.

I've followed a few simple rules:

1. Only peek at long functions
2. Scroll and look for strings
3. If the disassembly reveals more paths, explore it more (you can easily tell - Ghidra needs more time)

### Thank you logging!

As we've found out in [Day 6](Day_6_Did_I.md), there's a logging function that appends strings to `log/boutlog.txt`.

Fellow developers, please don't log your class structures and/or names:

```asm
009a6c50 | : CBattleRoom()
009a6c94 | : ~CBattleRoom()
009a6de8 | \source\userinterface\cbattleroom.cpp
009a6e18 | CBattleRoom::InitializeHost()
009a6e48 | CBattleRoom::NetworkProc(void)
009a6ea8 | CBattleRoom::CommandGameJoinNew() - id %d addr_in   %s port %d
009a6ef4 | CBattleRoom::CommandGameJoinNew() - id %d addr_in_virtual  %s port %d
009a6f48 | CBattleRoom::RequestStartGame()
009a6f70 | CBattleRoom::ReplyStartGame() : map_no : %d, room_no : %d
009a6fb8 | CBattleRoom::ReplyStartGame()
009a6fdc | CBattleRoom::RequestCreateGame()
009a7004 | CBattleRoom::ReplyCreateGame()
009a702c | CBattleRoom::RequestGameInfoUpdate()
009a7058 | CBattleRoom::ReplyGameInfoUpdate()
009a7084 | CBattleRoom::RequestUserOut()
009a70a8 | CBattleRoom::ReplyUserOut()
009a70cc | CBattleRoom::RequestGameRoomExit()
009a70f8 | CBattleRoom::ReplyGameRoomExit()
009a9b74 | new CBattleRoom() : %d
```

This is only the `CBattleRoom` class. I can make the safe assumption that a guy by the name/nickname of `Gai` worked in [N-Log Soft](http://www.hardcoregaming101.net/korea/part2/company-kidnkid.htm) back in 2007.

> f:\bout가이\로움\source\userinterface\cbattleroom.cpp

or

> f:\Bout\Gai\Room\source\userinterface\cbattleroom.cpp

### Recreation?

Can I attempt to fully recreate the game in the future? There're so many of those log messages. I've literally started naming the Ghidra functions with the first log message that I see and it's so much clearer now!

When I successfully run the client, I will definitely try to reproduce the source code.

## OEP

Alright, I was supposed to find the OEP. Let's see what the virtual address table revealing may show us.

I'm dealing with C++ Runtime DirectX Game. I'm looking for 2 things:

1. `int WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd);`
2. C runtime Windows entry: `WinMainCRTStartup(void)`

Last time, I've found out which function shows the login screen via the `ui_100.tga` file, so in _*theory*_ if I see which functions call it, I should end up in `WinMain` and `WinMainCRTStartup`.

In Ghidra: `Right click on function -> Reference -> Show Call Trees for <function name>`

More exploration! As you can imagine, it's not as simple as `WinMainCRTStartup() -> WinMain() -> LoadingScreen()`. But eventually...

```asm
; Start of procedure
00759a76 | CALL | dword ptr [MISSING_GetVersionPtr ]
; Call to GetStartUpInfoA. This is auto-generated by the compiler.
00759b31 | PUSH | ECX
00759b32 | CALL | dword ptr [->KERNEL32.DLL::GetStartupInfoA ]
; Call FUN_0435dd0 with 4 parameters
00759b5e | MOV  | ECX ,dword ptr [EBP  + -0x6c ]
00759b61 | PUSH | ECX
00759b62 | MOV  | EDX ,dword ptr [EBP  + -0x64 ]
00759b65 | PUSH | EDX
00759b66 | PUSH | 0x0
00759b68 | PUSH | 0x0
00759b6a | CALL | dword ptr [DAT_00bb0df4]
00759b70 | PUSH | EAX
00759b71 | CALL | FUN_00435dd0
; Exit
00759b99 | ADD  | ESP ,0x8
00759b9c | RET  |
```

It took me about 2 hours to find the OEP with my method (aka tracing back), but it was worth it. I've found GameGuard code along the way and I've renamed so many functions! The plan has always been not only to unpack the executable, but also to remove the GameGuard dependency. I will need to understand the code and the different structs.

So, with no doubt, the OEP is `0x00759a76`.

### Easy method

Remember, we're getting quite a few arguments in the `WinMain`, so something must provide us with them. Look for calls for:

1. `GetStartupInfoA` / `GetStartupInfoW`
2. `GetCommandLineA` / `GetCommandLineW`
3. `GetModuleHandleA` / `GetModuleHandleW`
4. `GetEnvironmentStrings` / `FreeEnvironmentStrings`

Or just x64dbg... personally, I enjoy Ghidra more and I want to do exploration!

## Unpacked & OEP executable

I'm adding the unpacked executable with the correct EP (with partially fixed IAT) and the imports dumped by HollowsHunter in the repo:

- [unpacks/bots.dat_unpacked_oep_partial_iat.exe](../unpacks/bots.dat_unpacked_oep_partial_iat.exe)
- [unpacks/bots.dat_unpacked_oep_partial_iat.imports.txt](../unpacks/bots.dat_unpacked_oep_partial_iat.imports.txt)

I will add the Ghidra project in the future.

## Next steps

I think that it's time to get a working executable. I have to fix the IAT! There's no way around it. If I want to remove the GameGuard dependency, I should get a stable and working executable first, or at least something that lands me on the login screen.
